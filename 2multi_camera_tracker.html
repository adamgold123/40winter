<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>tracking.js - color with camera</title>
    <script src="js/tracking.js"></script>
    <script src="js/color_tracker.js"></script>
    <script src="js/jquery.js"></script>
    <style>
    video,
    canvas {
        margin-left: 100px;
        margin-top: 35px;
        position: absolute;
    }
    </style>
</head>

<body>
    Sensitivity:
    <input id="sensitivity" value="1000" />
    <div>r: <span id="r1">0</span>g: <span id="g1">255</span>b: <span id="b1">0</span></div>
    <div class="demo-title">
        Make changes in the code to track a custom color
    </div>
    <div class="demo-frame">
        <div class="demo-container">
            <video id="video" width="600" height="450" preload autoplay loop muted controls></video>
            <canvas id="canvas" width="600" height="450"></canvas>
        </div>
    </div>
    <script>
    window.onload = function() {
        var video = document.getElementById("video");
        var canvas = document.getElementById("canvas");
        var context = canvas.getContext("2d");
        sensitivity = $("#sensitivity").text();;
        var r1 = $("#r1").text();
        var g1 = $("#g1").text();
        var b1 = $("#b1").text();

        //change the numbers below to correspond to the color you want to track
        tracking.ColorTracker.registerColor("c1", function(r, g, b) {

            var threshold = $("#r1").text();
            dx = r - r1,
                dy = g - g1,
                dz = b - b1;

            return dx * dx + dy * dy + dz * dz < sensitivity; //make this number larger to match more co]ors
        });
        tracking.ColorTracker.registerColor("c2", function(r, g, b) {
            // console.log(r,g,b)
            var threshold =
                dx = r - 50,
                dy = g - 120,
                dz = b - 100;

            return dx * dx + dy * dy + dz * dz < sensitivity; //make this number larger to match more co]ors
        });
        //Tracks the basic colors and the custom color
        var tracker = new tracking.ColorTracker(["c1", "c2"]);
        //Use this instead of the above if you just want to track the custom color
        //var tracker = new tracking.ColorTracker("custom");

        tracking.track("#video", tracker, {
            camera: true
        });

        function rgb(r, g, b) {
            return "rgb(" + r + "," + g + "," + b + ")";
        }
        tracker.on("track", function(event) {
            context.clearRect(0, 0, canvas.width, canvas.height);
            var c2 = [];
            var c1Pos = [];
            event.data.forEach(function(rect) {
                if (rect.color === "c1") {
                    rect.color = rgb(r1, g1, b1);
                    c1Pos.push(rect.x);
                } else if (rect.color === "c2") {
                    rect.color = "#00FF00";
                    c2.push(rect.x);
                }

                context.strokeStyle = rect.color;
                context.strokeRect(rect.x, rect.y, rect.width, rect.height);
                context.font = "11px Helvetica";
                context.fillStyle = rect.color;
                context.fillText("x: " + rect.x + "px", rect.x + rect.width + 5, rect.y + 11);
                context.fillText("y: " + rect.y + "px", rect.x + rect.width + 5, rect.y + 22);
            });

        });


        function findPos(obj) {
            var current_left = 0,
                current_top = 0;
            if (obj.offsetParent) {
                do {
                    current_left += obj.offsetLeft;
                    current_top += obj.offsetTop;
                } while (obj = obj.offsetParent);
                return {
                    x: current_left,
                    y: current_top
                };
            }
            return undefined;
        }

        $('#canvas').click(function(e) {
            console.log('click video')
            var position = findPos(this);
            var x = e.pageX - position.x;
            var y = e.pageY - position.y;
            var coordinate = "x=" + x + ", y=" + y;
            var canvas = this.getContext('2d');
            canvas.drawImage(video, 0, 0, 600, 400);
            var p = canvas.getImageData(x, y, 1, 1).data;
            $("#r1").text(p[0]);
            $("#g1").text(p[1]);
            $("#b1").text(p[2]);
            $("#a").text(p[3]);
            sensitivity = $("#sensitivity").val();
            r1 = p[0];
            g1 = p[1];
            b1 = p[2];
        });
    };
    </script>
</body>

</html>
